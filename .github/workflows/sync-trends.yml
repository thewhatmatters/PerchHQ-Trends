name: Sync Trends to Supabase

on:
  push:
    paths:
      - 'trends/*.json'
    branches:
      - main
  schedule:
    # 5:30 AM CST (11:30 UTC) daily — safety net in case push trigger misses
    - cron: '30 11 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Find changed trend files
        id: changed
        run: |
          FILES=$(git diff --name-only HEAD~1 HEAD -- 'trends/*.json' 2>/dev/null | tr '\n' ' ')
          if [ -z "$(echo "$FILES" | tr -d ' ')" ]; then
            # On manual dispatch or schedule, sync all files
            FILES=$(ls trends/*.json 2>/dev/null | tr '\n' ' ')
          fi
          FILES=$(echo "$FILES" | xargs)
          if [ -z "$FILES" ]; then
            echo "No trend files found"
            echo "files=" >> $GITHUB_OUTPUT
          else
            echo "Files to sync: $FILES"
            echo "files=$FILES" >> $GITHUB_OUTPUT
          fi

      - name: Sync to Supabase
        if: steps.changed.outputs.files != ''
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -e

          for FILE in ${{ steps.changed.outputs.files }}; do
            echo "========================================="
            echo "Processing $FILE..."
            echo "========================================="

            # Validate JSON
            if ! python3 -c "import json; json.load(open('$FILE'))"; then
              echo "ERROR: Invalid JSON in $FILE"
              exit 1
            fi

            # Count trends (handle both bare array and wrapped object formats)
            COUNT=$(python3 -c "
          import json
          raw = json.load(open('$FILE'))
          trends = raw.get('trends', raw) if isinstance(raw, dict) else raw
          print(len(trends))
          ")
            echo "Found $COUNT trend(s) in $FILE"

            # Insert trends via Supabase REST API (skip duplicates)
            python3 - "$FILE" << 'PYTHON'
          import json, os, re, sys, urllib.request, urllib.error

          UUID_RE = re.compile(r'^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$', re.I)

          supabase_url = os.environ["SUPABASE_URL"]
          service_key = os.environ["SUPABASE_SERVICE_ROLE_KEY"]
          filepath = sys.argv[1]

          with open(filepath) as f:
              raw = json.load(f)

          # Support both formats:
          #   Bare array:    [{trend}, {trend}, ...]
          #   Wrapped object: {"batch_id": ..., "scraped_at": ..., "trends": [...]}
          if isinstance(raw, list):
              trends = raw
              batch_defaults = {}
          else:
              trends = raw.get("trends", [])
              batch_defaults = {
                  "scraped_at": raw.get("scraped_at"),
                  "expires_at": raw.get("expires_at"),
                  "batch_id": raw.get("batch_id"),
              }

          inserted = 0
          skipped = 0
          errors = 0

          for trend in trends:
              # batch_id column is UUID — only include if valid UUID, else omit
              batch_id = trend.get("batch_id", batch_defaults.get("batch_id"))
              if batch_id and not UUID_RE.match(str(batch_id)):
                  batch_id = None

              row = {
                  "scraped_at": trend.get("scraped_at", batch_defaults.get("scraped_at")),
                  "headline": trend["headline"],
                  "body": trend["body"],
                  "categories": trend["categories"],
                  "source": trend.get("source"),
                  "source_url": trend.get("source_url"),
                  "trend_type": trend.get("trend_type"),
                  "status": trend.get("status", "raw"),
                  "confidence_score": trend.get("confidence_score"),
                  "relevance_score": trend.get("relevance_score"),
                  "expires_at": trend.get("expires_at", batch_defaults.get("expires_at")),
                  "batch_id": batch_id,
                  "metadata": trend.get("metadata", {}),
              }

              data = json.dumps(row).encode()
              req = urllib.request.Request(
                  f"{supabase_url}/rest/v1/trends",
                  data=data,
                  headers={
                      "apikey": service_key,
                      "Authorization": f"Bearer {service_key}",
                      "Content-Type": "application/json",
                      "Prefer": "resolution=ignore-duplicates",
                  },
                  method="POST",
              )

              try:
                  urllib.request.urlopen(req)
                  inserted += 1
                  print(f"  + {trend['headline'][:70]}")
              except urllib.error.HTTPError as e:
                  body = e.read().decode()
                  if "duplicate" in body.lower() or e.code == 409:
                      skipped += 1
                      print(f"  ~ SKIP (duplicate): {trend['headline'][:50]}")
                  else:
                      errors += 1
                      print(f"  ! ERROR: {trend['headline'][:50]} -> {e.code} {body}")

          print(f"\nResult: {inserted} inserted, {skipped} duplicates skipped, {errors} errors")
          if errors > 0:
              sys.exit(1)
          PYTHON

          done

          echo ""
          echo "Sync complete!"
